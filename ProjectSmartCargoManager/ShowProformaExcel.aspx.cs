using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Microsoft.Reporting.WebForms;
using System.Data;
using System.IO;
using System.Configuration;
using System.Net;
using System.Net.Mail;
using System.Net.NetworkInformation;

namespace ProjectSmartCargoManager
{
    public partial class ShowProformaExcel : System.Web.UI.Page
    {
        ReportDataSource rds1 = new ReportDataSource();
        ReportDataSource rds2 = new ReportDataSource();
        DataTable dtTable1 = new DataTable();
        DataTable dtTable2 = new DataTable();
        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {

                dtTable1 = (DataTable)Session["ShowExcel"];
                dtTable2 = (DataTable)Session["ShowExcelHeader"];

                ReportViewer1.Visible = true;



                ReportViewer1.Reset();

                ReportViewer1.ProcessingMode = ProcessingMode.Local;

                LocalReport rep1 = ReportViewer1.LocalReport;

                rep1.ReportPath = Server.MapPath("/Reports/ProformaInvoice1.rdlc");
                //rep1.ReportPath = System.Configuration.ConfigurationManager.AppSettings["ReportPath"] + "ProformaInvoice1.rdlc";
                rds1.Name = "dsBilling_DataTable1";
                rds1.Value = dtTable1;
                rep1.DataSources.Add(rds1);

                ReportViewer1.LocalReport.SubreportProcessing += new SubreportProcessingEventHandler(ItemsSubreportProcessingEventHandler);

                //Code to Save the generated Proforma Invoice Excel file
                SaveAgentInvoice();

            }
            catch (Exception ex)
            {

            }
        }

        //Contains code to "Save" Proforma Invoice xls file, send it as attachment and "Delete" Proforma Invoice xls file from disk
        protected void SaveAgentInvoice()
        {
            //Code to Save Proforma Invoice xls file
            Microsoft.Reporting.WebForms.Warning[] warnings;
            string[] streamids;
            string mimeType;
            string encoding;
            string extension;
            Byte[] bytes;
            bytes = ReportViewer1.LocalReport.Render("Excel", string.Empty, out mimeType, out encoding,
                        out extension, out streamids, out warnings);
            FileStream fs = new FileStream(@"c:\ProformaInvoice.xls", FileMode.Create);
            fs.Write(bytes, 0, bytes.Length);
            fs.Close();
            //fs.Dispose();

            //Code to send it as attachment in mail
            SendMail();

            //Code to Delete Proforma Invoice xls file
            string filePath = @"c:\ProformaInvoice.xls";
            if (System.IO.File.Exists(filePath))
            {
                System.IO.File.Delete(filePath);
            }

        }

        public bool SendMail()
        {
            
            try
            {
                MailMessage Mail = new MailMessage();
                Mail.From = new MailAddress(ConfigurationManager.AppSettings["FromAddress"].ToString());
                Mail.To.Add(new MailAddress(ConfigurationManager.AppSettings["ToAddress"].ToString()));
                Mail.Subject = " Proforma Invoice ";
                Mail.IsBodyHtml = true;


                string Body = "Hello,<br/><br/><br/>";
                Body += "Please find the attached Proforma Invoice<br/><br/>";
                Body += "Thanks,<br/>QID Cargo Team<br/><br/><br/>";
                Body += "Note: This is as autogenerated E-mail. Please do not reply.";

                Mail.Body = Body.ToString();


                /* Get the file name */
                string strFileName = @"c:\ProformaInvoice.xls";
                System.Net.Mail.Attachment attach = new System.Net.Mail.Attachment(strFileName);
                /* Attach the newly created email attachment */
                Mail.Attachments.Add(attach);
                /* Store the attach filename so we can delete it later */
                string attach1 = strFileName;

                SmtpClient smtp = new SmtpClient("smtpout.secureserver.net", 25);
                string from = ConfigurationManager.AppSettings["FromAddress"].ToString();
                string pass = ConfigurationManager.AppSettings["Pass"].ToString();
                smtp.Credentials = new NetworkCredential(from, pass);
                Mail.Priority = MailPriority.High;

                smtp.Send(Mail);
                Mail.Dispose();
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
            //finally
            //{
            //    if (attach1 != null)
            //        File.Delete(attach1);
            //}
        }

        public void ItemsSubreportProcessingEventHandler(object sender, SubreportProcessingEventArgs e)
        {
            e.DataSources.Add(new ReportDataSource("dsBilling_DataTable2", dtTable2));

        }
    }
}
